<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¢ãƒã‚¤ãƒ«æ³¨æ–‡ãƒ¡ãƒ‹ãƒ¥ãƒ¼ | T1-T6ãƒ†ãƒ¼ãƒ–ãƒ«å¯¾å¿œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®šã¨åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #eef1f5; 
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼è¨­å®š */
        .bg-primary-blue { background-color: #3b82f6; } /* é’ */
        .hover\:bg-primary-hover:hover { background-color: #2563eb; } /* æ¿ƒã„é’ */
        .text-primary-blue { color: #3b82f6; }
        .bg-icon-green { background-color: #10b981; } /* ç·‘ */
        .text-icon-green { color: #10b981; }
        .text-icon-yellow { color: #f59e0b; } /* é»„ */
        .bg-soft-red { background-color: #ef4444; } /* èµ¤ */

        /* ãƒãƒƒãƒ—é¸æŠãƒœã‚¿ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .tip-label { flex-grow: 1; text-align: center; }
        .tip-button {
            display: block;
            padding: 8px 0; 
            font-size: 0.95rem; 
            font-weight: 600; 
            border-radius: 9999px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            color: #4b5563;
            width: 100%;
        }
        .tip-button.tip-selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5), 0 2px 4px -2px rgba(59, 130, 246, 0.5);
        }
        .tip-button.tip-unselected:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="table-modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" style="display: none;">
        <div id="table-modal-container" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            </div>
    </div>

    <header id="main-header" class="bg-white shadow-md sticky top-0 z-10 hidden">
        <div class="max-w-xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 id="full-header-title" class="text-xl font-extrabold text-gray-900">
                </h1>
            <button id="lang-toggle" class="text-sm font-semibold text-primary-blue" onclick="toggleLanguage()">
                </button>
        </div>
    </header>

    <main id="main-content" class="flex-grow pt-4 pb-4 px-4 overflow-auto hidden">
        <div class="max-w-xl mx-auto">
            
            <div class="mb-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800" id="menu-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                <button id="vegan-filter-button" 
                    class="flex items-center space-x-1 px-3 py-1.5 text-sm font-semibold rounded-full bg-gray-300 hover:bg-gray-400 transition-colors"
                    onclick="toggleVeganFilter()">
                    <span id="filter-label"></span>
                </button>
            </div>

            <div class="overflow-x-auto whitespace-nowrap py-2 mb-4">
                <div id="category-tabs" class="flex space-x-3">
                    </div>
            </div>

            <div id="product-list" class="space-y-3 pb-4">
                </div>
            
        </div>
    </main>

    <footer id="main-footer" class="bg-white shadow-2xl p-4 sticky bottom-0 z-10 hidden">
        <div class="max-w-xl mx-auto">
            
            <div class="flex justify-between items-center mb-3">
                <span id="item-count" class="text-sm font-semibold text-gray-600">
                    </span>
                <div id="message-area" class="text-xs font-semibold"></div>
            </div>

            <div class="px-4 py-2 text-center">
                <button id="tip-detail-toggle" class="text-xs text-gray-500 hover:text-gray-700 font-semibold mb-2" onclick="toggleTipDetails()">
                    </button>
            </div>

            <div id="tip-details-box" class="px-4 pb-2 hidden">
                <p id="tip-rate-label" class="text-sm font-semibold mb-2 text-gray-600 text-center">ãƒãƒƒãƒ—ç‡ã‚’é¸æŠã—ã¦ãã ã•ã„:</p>
                
                <div id="tip-buttons" class="flex space-x-2 mb-4">
                    </div>

                <div class="flex justify-between items-center text-sm mb-1">
                    <span id="subtotal-label" class="text-gray-600">å°è¨ˆ</span>
                    <span id="subtotal-amount" class="font-semibold text-gray-800">0å††</span>
                </div>
                <div class="flex justify-between items-center text-sm mb-2 border-b pb-2">
                    <span id="tip-label" class="text-gray-600">ãƒãƒƒãƒ—</span>
                    <span id="tip-amount" class="font-semibold text-primary-blue">0å††</span>
                </div>
            </div>

            <div class="flex justify-between items-center text-xl font-extrabold mb-4 pt-2">
                <span id="total-label" class="text-gray-800">åˆè¨ˆè«‹æ±‚é¡</span>
                <span id="total-amount" class="text-primary-blue">0å††</span>
            </div>

            <button id="order-btn" disabled 
                class="w-full py-4 text-xl font-bold rounded-xl shadow-lg transition-colors bg-gray-400 text-white cursor-not-allowed"
                onclick="sendOrder()">
                </button>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ------------------------------------------------------
        // I. å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©
        // ------------------------------------------------------
        const TABLES = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'];
        const TAX_RATE = 0.10; // 10% (æœªä½¿ç”¨ã ãŒå®šç¾©ã¨ã—ã¦æ®‹ã™)
        const TIP_RATES = [0, 10, 15, 20]; 
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // çŠ¶æ…‹ç®¡ç†
        let currentTable = null; 
        let currentLang = 'ja'; 
        let isVeganFilterActive = false;
        let currentCategory = 'ã™ã¹ã¦';
        let currentTipRate = TIP_RATES[0]; 
        let cart = {}; // ã‚«ãƒ¼ãƒˆã®ä¸­èº«: { 'å•†å“ã‚³ãƒ¼ãƒ‰': { product, quantity, price } }
        
        // UIãƒ†ã‚­ã‚¹ãƒˆã®å¤šè¨€èªå¯¾å¿œãƒ‡ãƒ¼ã‚¿
        const TEXTS = {
            'ja': {
                header_title: 'ã®æ³¨æ–‡',
                header_subtitle: 'ã‚¿ãƒƒãƒã—ã¦æ³¨æ–‡æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
                lang_button: 'English',
                menu_title: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼',
                filter_vegan: 'ãƒ“ãƒ¼ã‚¬ãƒ³ã®ã¿',
                category_all: 'ã™ã¹ã¦',
                footer_subtotal: 'å°è¨ˆ',
                footer_tip: 'ãƒãƒƒãƒ—',
                footer_total: 'åˆè¨ˆè«‹æ±‚é¡',
                footer_points_1: 'ç‚¹ (å°è¨ˆ: ',
                footer_points_2: ')',
                footer_send: 'æ³¨æ–‡ã‚’é€ä¿¡',
                detail_close: 'ãƒãƒƒãƒ—/æ–™é‡‘è©³ç´°ã‚’é–‰ã˜ã‚‹',
                detail_open: 'ãƒãƒƒãƒ—/æ–™é‡‘è©³ç´°ã‚’é–‹ã',
                tip_label: 'ãƒãƒƒãƒ—ç‡ã‚’é¸æŠã—ã¦ãã ã•ã„:',
                tip_none: 'ãªã—',
                message_error: 'ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
                message_sent_success: 'æ³¨æ–‡ãŒã‚­ãƒƒãƒãƒ³ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼',
                message_sent_failure: 'æ³¨æ–‡é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                icon_vegan: 'ãƒ“ãƒ¼ã‚¬ãƒ³',
                icon_cooked: 'èª¿ç†æ¸ˆ',
                icon_allergy: 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼',
                not_found: 'è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚',
                image_text: 'å•†å“ç”»åƒ',
                select_table_title: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠä¸­...',
                table_display: 'ãƒ†ãƒ¼ãƒ–ãƒ«:',
            },
            'en': {
                header_title: ' Order',
                header_subtitle: 'Tap to input the quantity.',
                lang_button: 'æ—¥æœ¬èª',
                menu_title: 'Menu',
                filter_vegan: 'Vegan Only',
                category_all: 'All',
                footer_subtotal: 'Subtotal',
                footer_tip: 'Tip',
                footer_total: 'Total Amount Due',
                footer_points_1: ' items (Subtotal: ',
                footer_points_2: ')',
                footer_send: 'Send Order',
                detail_close: 'Hide Tip/Fee Details',
                detail_open: 'Show Tip/Fee Details',
                tip_label: 'Select Tip Percentage:',
                tip_none: 'None',
                message_error: 'Error: Cart is empty.',
                message_sent_success: 'Order sent to the kitchen!',
                message_sent_failure: 'Order failed to send.',
                icon_vegan: 'Vegan',
                icon_cooked: 'Cooked',
                icon_allergy: 'Allergens',
                not_found: 'No matching products found.',
                image_text: 'Product Image',
                select_table_title: 'Selecting Table...',
                table_display: 'Table:',
            }
        };

        // Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBWVkm-z2b5Gc3NgaxRYqCArc3_1qGXt6M",
            authDomain: "atsushi-menu-order.firebaseapp.com",
            databaseURL: "https://atsushi-menu-order-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "atsushi-menu-order",
            storageBucket: "atsushi-menu-order.firebasestorage.app",
            messagingSenderId: "646826055037",
            appId: "1:646826055037:web:67b13209ccd675326ee814",
            measurementId: "G-ZL674LSY85"
        };
        
        // ------------------------------------------------------
        // II. UIåˆ¶å¾¡ã¨ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°
        // ------------------------------------------------------

        /**
         * ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
         */
        function getText(key) {
            return TEXTS[currentLang][key] || key;
        }
        
        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
         */
        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = text;
            messageArea.className = 'text-xs font-semibold transition-opacity duration-300';

            // ã‚¹ã‚¿ã‚¤ãƒ«ã®è¨­å®š
            if (type === 'success') {
                messageArea.classList.add('text-icon-green');
            } else if (type === 'error') {
                messageArea.classList.add('text-soft-red');
            } else {
                messageArea.classList.add('text-gray-500');
            }

            // ä¸€å®šæ™‚é–“å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                messageArea.classList.remove('text-icon-green', 'text-soft-red', 'text-gray-500');
                messageArea.innerHTML = '';
            }, 3000);
        }

        /**
         * å•†å“IDã‹ã‚‰å•†å“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
         */
        function findProductByCode(code) {
            return products.find(p => p.code === code);
        }
        
        /**
         * æŒ‡å®šã‚«ãƒ†ã‚´ãƒªã¨ãƒ“ãƒ¼ã‚¬ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åŸºã¥ã„ã¦å•†å“ãƒªã‚¹ãƒˆã‚’å–å¾—
         */
        function getProductsByCategory(category, isVegan) {
            let filteredProducts = products;

            if (category !== getText('category_all')) {
                filteredProducts = filteredProducts.filter(p => p[`category_${currentLang}`] === category);
            }

            if (isVegan) {
                filteredProducts = filteredProducts.filter(p => p.isVegan);
            }
            
            return filteredProducts;
        }

        /**
         * ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ã‚’è¿½åŠ /æ›´æ–°
         */
        function updateCart(code, quantity) {
            if (quantity <= 0) {
                delete cart[code];
            } else {
                const product = findProductByCode(code);
                if (product) {
                    cart[code] = { 
                        product: product, 
                        quantity: quantity, 
                        price: product.price 
                    };
                }
            }
            // å•†å“ãƒªã‚¹ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„ã¨ã€æ•°é‡ãŒã™ãã«åæ˜ ã•ã‚Œãªã„ãŸã‚
            renderProductList(); 
            updateTotal();
        }

        /**
         * ã‚«ãƒ¼ãƒˆå†…å•†å“ã®æ•°é‡ã‚’å¢—ã‚„ã™
         */
        function increaseQuantity(code) {
            const currentQty = cart[code] ? cart[code].quantity : 0;
            updateCart(code, currentQty + 1);
        }

        /**
         * ã‚«ãƒ¼ãƒˆå†…å•†å“ã®æ•°é‡ã‚’æ¸›ã‚‰ã™
         */
        function decreaseQuantity(code) {
            const currentQty = cart[code] ? cart[code].quantity : 0;
            updateCart(code, currentQty - 1);
        }
        
        /**
         * æ•°å€¤ã‚’é€šè²¨å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         */
        function formatCurrency(amount) {
            const formatter = new Intl.NumberFormat(currentLang === 'ja' ? 'ja-JP' : 'en-US', {
                style: 'currency',
                currency: currentLang === 'ja' ? 'JPY' : 'USD', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(amount);
            
            return currentLang === 'ja' ? formatter.replace('Â¥', '') + 'å††' : formatter;
        }

        /**
         * ãƒãƒƒãƒ—ç‡ã®è¡¨ç¤ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         */
        function formatTipRate(rate) {
            return rate === 0 ? getText('tip_none') : `${rate}%`;
        }

        /**
         * å¤‰æ›´ã•ã‚Œãªã„é™çš„ãªUIè¦ç´ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆä¸»ã«è¨€èªä¾å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
         */
        function renderStaticElements() {
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨€èªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            document.getElementById('lang-toggle').innerHTML = getText('lang_button');

            // ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–° (ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠå¾Œã¯ãƒ†ãƒ¼ãƒ–ãƒ«IDãŒè¡¨ç¤ºã•ã‚Œã¾ã™)
            const headerTitleElement = document.getElementById('full-header-title');
            if (headerTitleElement) {
                headerTitleElement.innerHTML = 
                    currentTable ? `${getText('table_display')} ${currentTable} ${getText('header_title')}` : getText('select_table_title');
            }
            
            // ãƒ“ãƒ¼ã‚¬ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆ
            document.getElementById('filter-label').innerHTML = getText('filter_vegan');
            document.getElementById('menu-title').innerHTML = getText('menu_title');
            
            // ãƒ•ãƒƒã‚¿ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆ
            document.getElementById('subtotal-label').innerHTML = getText('footer_subtotal');
            document.getElementById('tip-label').innerHTML = getText('footer_tip');
            document.getElementById('total-label').innerHTML = getText('footer_total');
            document.getElementById('order-btn').innerHTML = getText('footer_send');

            // ãƒãƒƒãƒ—è©³ç´°ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¾åœ¨ã®çŠ¶æ…‹ã«å¿œã˜ã¦æ›´æ–°
            const detailsBox = document.getElementById('tip-details-box');
            const toggleButton = document.getElementById('tip-detail-toggle');
            
            if (toggleButton && detailsBox) {
                toggleButton.innerHTML = 
                    detailsBox.classList.contains('hidden') ? 
                    getText('detail_open') : getText('detail_close');
            }
            
            // ãƒãƒƒãƒ—ç‡é¸æŠã®è¦‹å‡ºã—
            document.getElementById('tip-rate-label').innerHTML = getText('tip_label');
        }

        /**
         * ã‚«ãƒ¼ãƒˆå†…ã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
         */
        function calculateTotal() {
            let subtotal = 0;
            let itemCount = 0;
            for (const code in cart) {
                subtotal += cart[code].product.price * cart[code].quantity;
                itemCount += cart[code].quantity;
            }

            const tipAmount = Math.round(subtotal * (currentTipRate / 100));
            const total = subtotal + tipAmount;

            return { subtotal, tipAmount, total, itemCount };
        }

        /**
         * åˆè¨ˆé‡‘é¡ã‚’æ›´æ–°ã—ã€ãƒ•ãƒƒã‚¿ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function updateTotal() {
            const totals = calculateTotal();
            const subtotalElement = document.getElementById('subtotal-amount');
            const tipElement = document.getElementById('tip-amount');
            const totalElement = document.getElementById('total-amount');
            const itemCountElement = document.getElementById('item-count');
            const orderBtn = document.getElementById('order-btn');

            if (!subtotalElement || !tipElement || !totalElement || !itemCountElement || !orderBtn) return;


            // é‡‘é¡è¡¨ç¤ºã®æ›´æ–°
            subtotalElement.innerHTML = formatCurrency(totals.subtotal);
            tipElement.innerHTML = formatCurrency(totals.tipAmount);
            totalElement.innerHTML = formatCurrency(totals.total);
            
            // ã‚¢ã‚¤ãƒ†ãƒ æ•°ã®æ›´æ–°
            itemCountElement.innerHTML = `${totals.itemCount}${getText('footer_points_1')}${formatCurrency(totals.subtotal)}${getText('footer_points_2')}`;
            
            // æ³¨æ–‡ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
            if (totals.itemCount > 0) {
                orderBtn.disabled = false;
                orderBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                orderBtn.classList.add('bg-primary-blue', 'hover:bg-primary-hover');
            } else {
                orderBtn.disabled = true;
                orderBtn.classList.remove('bg-primary-blue', 'hover:bg-primary-hover');
                orderBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        /**
         * è¨€èªåˆ‡ã‚Šæ›¿ãˆ
         */
        function toggleLanguage() {
            currentLang = currentLang === 'ja' ? 'en' : 'ja';
            // ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            currentCategory = getText('category_all'); 
            renderAllUI();
        }

        /**
         * ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderCategoryTabs() {
            const tabContainer = document.getElementById('category-tabs');
            if (!tabContainer) return;

            // ã‚«ãƒ†ã‚´ãƒªã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒªã‚¹ãƒˆã‚’å–å¾— (ç¾åœ¨ã®è¨€èªã‚’ä½¿ç”¨)
            const categories = [...new Set(products.map(p => p[`category_${currentLang}`]))]; 
            categories.unshift(getText('category_all')); 

            let html = '';
            categories.forEach(category => {
                const isActive = category === currentCategory;
                const buttonClass = isActive
                    ? 'bg-primary-blue text-white'
                    : 'text-gray-600 hover:bg-gray-200';
                
                // onmousedown/ontouchstartã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã€onclickã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
                html += `
                    <button class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap transition-colors ${buttonClass}" 
                        onclick="selectCategory('${category.replace(/'/g, "\\'")}')">
                        ${category}
                    </button>
                `;
            });
            tabContainer.innerHTML = html;
        }

        /**
         * ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒãƒ³ãƒ‰ãƒ©
         */
        function selectCategory(category) {
            currentCategory = category;
            renderProductList();
            renderCategoryTabs(); // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        }
        
        /**
         * ãƒ“ãƒ¼ã‚¬ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°/åˆ¶å¾¡
         */
        function renderFilterControls() {
            const filterButton = document.getElementById('vegan-filter-button');
            if (!filterButton) return;

            if (isVeganFilterActive) {
                filterButton.classList.remove('bg-gray-300', 'hover:bg-gray-400');
                filterButton.classList.add('bg-icon-green', 'text-white');
            } else {
                filterButton.classList.remove('bg-icon-green', 'text-white');
                filterButton.classList.add('bg-gray-300', 'hover:bg-gray-400');
            }
        }

        /**
         * ãƒ“ãƒ¼ã‚¬ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒˆã‚°ãƒ«
         */
        function toggleVeganFilter() {
            isVeganFilterActive = !isVeganFilterActive;
            renderProductList();
            renderFilterControls();
        }

        /**
         * å•†å“ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderProductList() {
            const listContainer = document.getElementById('product-list');
            if (!listContainer) return;

            const filteredProducts = getProductsByCategory(currentCategory, isVeganFilterActive);

            if (filteredProducts.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        ${getText('not_found')}
                    </div>
                `;
                return;
            }

            let html = '';
            filteredProducts.forEach(product => {
                const currentQty = cart[product.code] ? cart[product.code].quantity : 0;
                const name = product[`name_${currentLang}`] || product.name_ja;
                const notes = product[`notes_${currentLang}`] || product.notes_ja;

                // ã‚¢ã‚¤ã‚³ãƒ³ã®ç”Ÿæˆ
                let icons = '';
                if (product.isVegan) {
                    icons += `<span title="${getText('icon_vegan')}" class="text-icon-green">ğŸŒ¿</span>`;
                }
                if (product.isCooked) {
                    icons += `<span title="${getText('icon_cooked')}" class="text-icon-yellow">ğŸ”¥</span>`;
                }
                if (product.hasAllergens) {
                    icons += `<span title="${getText('icon_allergy')}" class="text-soft-red">âš ï¸</span>`;
                }

                html += `
                    <div class="flex items-center bg-white p-3 rounded-xl shadow-sm space-x-3 mb-3" onclick="increaseQuantity('${product.code}')">
                        
                        <div class="flex-grow">
                            <div class="font-bold text-gray-800">${name}</div>
                            <div class="text-sm text-gray-500">${notes}</div>
                            <div class="text-lg font-bold text-primary-blue">${formatCurrency(product.price)}</div>
                        </div>

                        <div class="flex flex-col items-end space-y-2">
                            <div class="flex space-x-1 text-base">
                                ${icons}
                            </div>
                            
                            ${currentQty > 0 ? `
                                <div class="flex items-center space-x-1 bg-primary-blue text-white rounded-full p-1 shadow-md">
                                    <button class="w-6 h-6 flex items-center justify-center rounded-full bg-white text-primary-blue hover:bg-gray-100" 
                                            onclick="event.stopPropagation(); decreaseQuantity('${product.code}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                                    </button>
                                    <span class="font-semibold text-sm w-4 text-center text-white">${currentQty}</span>
                                    <button class="w-6 h-6 flex items-center justify-center rounded-full bg-white text-primary-blue hover:bg-gray-100" 
                                            onclick="event.stopPropagation(); increaseQuantity('${product.code}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                    </button>
                                </div>
                            ` : `
                                <button class="w-16 h-8 text-sm font-semibold text-gray-700 rounded-full border-2 border-gray-300 hover:bg-gray-100 transition-colors"
                                        onclick="event.stopPropagation(); increaseQuantity('${product.code}')">
                                    è¿½åŠ 
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        /**
         * ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
         */
        function showTableModal() {
            const overlay = document.getElementById('table-modal-overlay');
            const mainContent = document.getElementById('main-content');
            const mainFooter = document.getElementById('main-footer');
            const header = document.getElementById('main-header');
            const modalContainer = document.getElementById('table-modal-container');

            if (!overlay || !mainContent || !mainFooter || !header || !modalContainer) return;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            let tableButtonsHtml = TABLES.map(table => 
                `<button class="w-24 h-24 bg-primary-blue text-white text-xl font-bold rounded-xl shadow-lg hover:bg-primary-hover transition-colors" onclick="selectTable('${table}')">${table}</button>`
            ).join('');

            modalContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800">${getText('select_table_title')}</h2>
                <div class="grid grid-cols-3 gap-4">${tableButtonsHtml}</div>
            `;
            
            // UIã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
            overlay.style.display = 'flex';
            mainContent.classList.add('hidden');
            mainFooter.classList.add('hidden');
            header.classList.add('hidden');
        }

        /**
         * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã€ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {string} table - é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ID (ä¾‹: 'T1')
         */
        function selectTable(table) {
            currentTable = table;
            const overlay = document.getElementById('table-modal-overlay');
            const mainContent = document.getElementById('main-content');
            const mainFooter = document.getElementById('main-footer');
            const header = document.getElementById('main-header');

            if (!overlay || !mainContent || !mainFooter || !header) return;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã—ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            overlay.style.display = 'none';
            mainContent.classList.remove('hidden');
            mainFooter.classList.remove('hidden');
            header.classList.remove('hidden');

            // UIã‚’å®Œå…¨ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderAllUI();
        }
        
        /**
         * ãƒãƒƒãƒ—è©³ç´°ãƒœãƒƒã‚¯ã‚¹ã®ãƒˆã‚°ãƒ«
         */
        function toggleTipDetails() {
            const detailsBox = document.getElementById('tip-details-box');
            if (!detailsBox) return;

            detailsBox.classList.toggle('hidden');
            renderStaticElements(); // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        }

        /**
         * ãƒãƒƒãƒ—é¸æŠãƒœã‚¿ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderTipButtons() {
            const buttonContainer = document.getElementById('tip-buttons');
            if (!buttonContainer) return;

            let html = TIP_RATES.map(rate => {
                const isSelected = rate === currentTipRate;
                const buttonClass = isSelected ? 'tip-selected bg-primary-blue text-white' : 'tip-unselected';
                const rateText = formatTipRate(rate);

                return `
                    <div class="tip-label">
                        <button class="tip-button ${buttonClass}" 
                            onclick="selectTip(${rate})">
                            ${rateText}
                        </button>
                    </div>
                `;
            }).join('');
            
            buttonContainer.innerHTML = html;
        }

        /**
         * ãƒãƒƒãƒ—ç‡ã®é¸æŠ
         */
        function selectTip(rate) {
            currentTipRate = rate;
            renderTipButtons(); // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            updateTotal(); // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
        }
        
        /**
         * æ³¨æ–‡ã‚’Firebaseã«é€ä¿¡
         */
        function sendOrder() {
            const totals = calculateTotal();
            
            if (totals.itemCount === 0) {
                showMessage(getText('message_error'), 'error');
                return;
            }

            const orderDetails = {
                table: currentTable,
                subtotal: totals.subtotal,
                tip_rate: currentTipRate,
                tip_amount: totals.tipAmount,
                total: totals.total,
                items: Object.values(cart).map(item => ({
                    code: item.product.code,
                    name: item.product[`name_${currentLang}`] || item.product.name_ja,
                    quantity: item.quantity,
                    price: item.price,
                    line_total: item.price * item.quantity
                })),
                timestamp: new Date().toISOString()
            };

            const db = firebase.database();
            db.ref(`orders/${currentTable}/${Date.now()}`).set(orderDetails)
                .then(() => {
                    // æˆåŠŸæ™‚ã®å‡¦ç†
                    cart = {}; // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
                    renderAllUI();
                    showMessage(getText('message_sent_success'), 'success');
                })
                .catch((error) => {
                    // å¤±æ•—æ™‚ã®å‡¦ç†
                    console.error("Firebaseé€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                    showMessage(getText('message_sent_failure') + '\n' + error.message, 'error');
                });
        }

        /**
         * å…¨ã¦ã®UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°/æ›´æ–°
         */
        function renderAllUI() {
            renderStaticElements(); 
            renderFilterControls();
            renderCategoryTabs();
            renderProductList();
            renderTipButtons();
            updateTotal(); 
        }

        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            // FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
                firebase.initializeApp(firebaseConfig);
            }
            
            currentCategory = getText('category_all');
            
            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º (ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã¾ã§ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯éš ã‚Œã¦ã„ã‚‹)
            showTableModal(); 
        });


        // ------------------------------------------------------
        // III. å•†å“ãƒ‡ãƒ¼ã‚¿ (const products) ã®å®šç¾©
        // ------------------------------------------------------
        const products = [
            {
                code: 'P001', 
                name_ja: 'ã‚³ãƒ¼ãƒ’ãƒ¼', 
                name_en: 'Coffee', 
                price: 450, 
                isVegan: true, 
                isCooked: false, 
                hasAllergens: false, 
                notes_ja: 'ãƒ›ãƒƒãƒˆ/ã‚¢ã‚¤ã‚¹', 
                notes_en: 'Hot/Iced',
                category_ja: 'ãƒ‰ãƒªãƒ³ã‚¯',
                category_en: 'Drinks'
            },
            {
                code: 'P002', 
                name_ja: 'è‡ªå®¶è£½ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼', 
                name_en: 'Homemade Burger', 
                price: 1200, 
                isVegan: false, 
                isCooked: true, 
                hasAllergens: true, 
                notes_ja: 'ãƒ•ãƒ©ã‚¤ãƒ‰ãƒãƒ†ãƒˆä»˜ã', 
                notes_en: 'w/ Fries',
                category_ja: 'ãƒ¡ã‚¤ãƒ³',
                category_en: 'Main'
            },
            {
                code: 'P003', 
                name_ja: 'ãƒ´ã‚£ãƒ¼ã‚¬ãƒ³ã‚µãƒ©ãƒ€', 
                name_en: 'Vegan Salad', 
                price: 850, 
                isVegan: true, 
                isCooked: false, 
                hasAllergens: false, 
                notes_ja: 'è‡ªå®¶è£½ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°', 
                notes_en: 'Homemade Dressing',
                category_ja: 'ã‚µãƒ©ãƒ€',
                category_en: 'Salad'
            },
            {
                code: 'P004', 
                name_ja: 'ãƒ›ãƒƒãƒˆãƒ‰ãƒƒã‚°', 
                name_en: 'Hot Dog', 
                price: 700, 
                isVegan: false, 
                isCooked: true, 
                hasAllergens: true, 
                notes_ja: 'ãƒãƒ¼ã‚ºãƒˆãƒƒãƒ”ãƒ³ã‚°(+100)', 
                notes_en: 'Cheese topping (+100)',
                category_ja: 'ãƒ¡ã‚¤ãƒ³',
                category_en: 'Main'
            },
            {
                code: 'P005', 
                name_ja: 'ã‚³ãƒ¼ãƒ©', 
                name_en: 'Coke', 
                price: 300, 
                isVegan: true, 
                isCooked: false, 
                hasAllergens: false, 
                notes_ja: 'S/M/Lã‚µã‚¤ã‚º', 
                notes_en: 'S/M/L size',
                category_ja: 'ãƒ‰ãƒªãƒ³ã‚¯',
                category_en: 'Drinks'
            }
        ];
    </script>
</body>
</html>
