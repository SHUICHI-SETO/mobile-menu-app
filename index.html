<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>モバイル注文メニュー | T1-T6テーブル対応</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントの設定と基本スタイル */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #eef1f5; 
        }
        
        /* チップ選択ボタンのカスタムスタイル */
        .tip-label { flex-grow: 1; text-align: center; }
        .tip-button {
            display: block;
            padding: 8px 0; 
            font-size: 0.95rem; 
            font-weight: 600; 
            border-radius: 9999px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            color: #4b5563;
            width: 100%;
        }
        .tip-button.tip-selected {
            background-color: #f87171; /* soft-red */
            color: white;
            border-color: #f87171;
            box-shadow: 0 4px 6px rgba(248, 113, 113, 0.2);
        }

        /* 数量コントロールボタンの基本スタイル */
        .qty-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.15s;
            flex-shrink: 0;
        }

        /* カスタムカラー */
        .bg-soft-red { background-color: #f87171; }
        .text-icon-green { color: #10b981; } /* エメラルドグリーン */
        .text-icon-yellow { color: #facc15; } /* アンバー */
        .text-icon-red { color: #ef4444; } /* レッド */
        .bg-primary-blue { background-color: #3b82f6; }
        .bg-primary-hover { background-color: #2563eb; }

        /* モーダルオーバーレイ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* 初期状態では非表示 */
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        /* メッセージモーダル */
        #message-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 60;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>

    <div id="message-modal" class="bg-white">
        <p id="message-text" class="text-lg font-medium text-gray-800"></p>
        <button onclick="document.getElementById('message-modal').style.display='none';" class="mt-4 px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-primary-hover transition">OK</button>
    </div>

    <div id="table-modal-overlay" class="modal-overlay">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">テーブルを選択してください</h2>
            <div id="table-selection-grid" class="grid grid-cols-2 gap-4"> 
                </div>
            <p class="text-sm text-center text-gray-500 mt-6">
                ※一度選択すると、注文を送信するまでテーブルは変更できません。
            </p>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <header class="sticky top-0 bg-white shadow-md p-4 flex justify-between items-center z-40">
            <h1 id="full-header-title" class="text-xl font-bold text-gray-800">モバイル注文メニュー</h1>
            <button id="lang-button" onclick="toggleLanguage()" class="text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1 rounded-full hover:bg-gray-200 transition">EN</button>
        </header>

        <div class="p-4 bg-white sticky top-[68px] z-30 shadow-sm">
            <div class="flex space-x-2 mb-4">
                <button id="vegan-filter-button" onclick="toggleVeganFilter()" class="flex items-center text-sm font-medium bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition">
                    ビーガンのみ
                </button>
                </div>
            
            <div class="overflow-x-auto">
                <div id="category-tabs" class="flex space-x-3 pb-2">
                    </div>
            </div>
        </div>

        <main class="p-4 space-y-4 pb-[300px]">
            <div id="product-list" class="space-y-4">
                </div>
        </main>
    </div>

    <footer id="main-footer" class="fixed bottom-0 left-0 w-full bg-white shadow-2xl p-4 z-40" style="display: none;">
        <h2 class="text-lg font-bold text-gray-800 mb-3">カート <span id="cart-quantity-indicator" class="text-soft-red ml-2">0</span></h2>
        
        <div class="space-y-1 text-sm mb-3">
            <div class="flex justify-between">
                <span id="cart-subtotal-label">小計</span>
                <span id="cart-subtotal-value">¥0</span>
            </div>
            <div class="flex justify-between">
                <span id="cart-tax-label">税金 (10%)</span>
                <span id="cart-tax-value">¥0</span>
            </div>
            
            <div class="flex justify-between items-center py-2 border-t mt-2">
                <span id="cart-tip-label" class="font-bold">チップ</span>
                <span id="cart-tip-value" class="font-bold">¥0</span>
            </div>
            <div id="tip-buttons" class="grid grid-cols-4 gap-2 text-xs mb-3">
                </div>
            
            <div class="flex justify-between font-extrabold text-lg pt-2 border-t border-gray-300">
                <span id="cart-total-label">合計</span>
                <span id="cart-total-value" class="text-soft-red">¥0</span>
            </div>
        </div>
        
        <div class="mt-4 space-y-3">
            <label for="notes-input" id="notes-label" class="text-sm font-medium text-gray-700">備考:</label>
            <textarea id="notes-input" rows="2" class="w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="アレルギーや特別なリクエストがあれば記入してください"></textarea>
            
            <div class="flex space-x-3">
                <button id="clear-cart-button" onclick="clearCart()" class="w-1/3 bg-gray-400 text-white font-bold py-3 rounded-xl hover:bg-gray-500 transition">カートをクリア</button>
                <button id="send-order-button" onclick="sendOrder()" disabled class="w-2/3 bg-soft-red text-white font-bold py-3 rounded-xl opacity-50 cursor-not-allowed hover:bg-red-600 transition">注文を送信</button>
            </div>
        </div>
    </footer>


<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // ------------------------------------------------------
    // I. 定数とグローバル変数の定義
    // ------------------------------------------------------
    const TABLES = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'];
    const TAX_RATE = 0.10; // 10%
    const TIP_RATES = [0, 0.10, 0.15, 0.20]; // 0%, 10%, 15%, 20%
    
    // UIテキストの多言語対応データ
    const TEXTS = {
        'header_title': { ja: 'メニュー', en: 'Menu' },
        'table_display': { ja: 'テーブル', en: 'Table' },
        'select_table_title': { ja: 'テーブルを選択してください', en: 'Select your table' },
        'subtotal': { ja: '小計', en: 'Subtotal' },
        'tax': { ja: '税金 (10%)', en: 'Tax (10%)' },
        'tip': { ja: 'チップ', en: 'Tip' },
        'total': { ja: '合計', en: 'Total' },
        'send_order': { ja: '注文を送信', en: 'Send Order' },
        'clear_cart': { ja: 'カートをクリア', en: 'Clear Cart' },
        'notes_label': { ja: '備考:', en: 'Notes:' },
        'notes_placeholder': { ja: 'アレルギーや特別なリクエストがあれば記入してください', en: 'Enter any allergies or special requests.' },
        'filter_vegan': { ja: 'ビーガンのみ', en: 'Vegan Only' },
        'category_all': { ja: 'すべて', en: 'All' },
        'icon_vegan': { ja: 'ビーガン', en: 'Vegan' },
        'icon_cooked': { ja: '調理済み', en: 'Cooked' },
        'icon_allergy': { ja: 'アレルゲン含む', en: 'Contains Allergens' },
        'not_found': { ja: '選択されたカテゴリに商品がありません。', en: 'No products found in this category.' },
        'message_sent_success': { ja: '注文がキッチンに送信されました！', en: 'Order successfully sent to the kitchen!' },
        'message_sent_failure': { ja: '注文の送信に失敗しました。', en: 'Failed to send order.' },
        'confirm_clear': { ja: 'カートの内容をすべてクリアしてもよろしいですか？', en: 'Are you sure you want to clear the entire cart?' }
    };

        // Firebase初期化
        const firebaseConfig = {
            apiKey: "AIzaSyBWVkm-z2b5Gc3NgaxRYqCArc3_1qGXt6M",
            authDomain: "atsushi-menu-order.firebaseapp.com",
            databaseURL: "https://atsushi-menu-order-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "atsushi-menu-order",
            storageBucket: "atsushi-menu-order.firebasestorage.app",
            messagingSenderId: "646826055037",
            appId: "1:646826055037:web:67b13209ccd675326ee814",
            measurementId: "G-ZL674LSY85"
        };
        firebase.initializeApp(firebaseConfig);

    // 状態管理
    let currentTable = null;
    let currentLang = 'ja'; // 初期言語
    let isVeganFilterActive = false;
    let currentCategory = TEXTS.category_all.ja;
    let currentTipRate = TIP_RATES[0];
    let cart = {}; // カートの中身: { '商品コード': { product, quantity, price } }

    // Firebaseの初期化
    if (firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    
    // ------------------------------------------------------
    // ⚠️ 3. 商品データ (const products) の定義
    // ------------------------------------------------------
    
    // ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐
    // ⚠️ ここに、あなたの元のindex.htmlからコピーした
    // ⚠️ const products = [...] の完全な配列を貼り付けてください。
    // ⚠️ (アサヒスーパードライから金沢和牛ロールまですべて)
        const products = [
            { code: '1101', name_ja: 'アサヒスーパードライ (330ml)', name_en: 'Asahi Super Dry (330ml)', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ビール', notes_en: 'Beer', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1102', name_ja: 'アサヒ黒生 (330ml)', name_en: 'Asahi Kuro Nama (330ml)', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ビール', notes_en: 'Beer', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1121', name_ja: 'ブラッディ・マリー', name_en: 'Bloody Mary', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ウォッカ、トマトジュース、タバスコ', notes_en: 'Vodka, Tomato Juice, Tobasco', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1122', name_ja: 'スクリュー・ドライバー', name_en: 'Screwdriver', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ウォッカ、オレンジジュース、オレンジスライス', notes_en: 'Vodka, Orange Juice, Orange Slice', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1123', name_ja: 'オレンジ・ブーム', name_en: 'Orange Boom', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'オレンジリキュール、オレンジジュース', notes_en: 'Orange Liqueur, Orange Juice', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1124', name_ja: 'ブルーラグーン', name_en: 'Blue Lagoon', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ウォッカ、ブルーキュラソー、スプライト、レモン', notes_en: 'Vodka, Blue Curacao Liqueur, Sprite, Lemon', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1125', name_ja: 'メロン・ブーム', name_en: 'Melon Boom', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'メロンリキュール、メロンソーダ', notes_en: 'Melon Liqueur, Melon Soda Juice', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1126', name_ja: 'グリーン・ドラゴン', name_en: 'Green Dragon', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'グリーンリキュール、ジンジャーソーダ', notes_en: 'Green Liqueur, Ginger Soda Juice', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1127', name_ja: 'ストロベリー・ブーム', name_en: 'Strawberry Boom', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ストロベリーリキュール、ストロベリーソーダ', notes_en: 'Strawberry Liqueur, Strawberry Soda Juice', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1128', name_ja: 'ウィスキーコーク', name_en: 'Whiskey Cola', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ウィスキー、コーラ', notes_en: 'Whiskey, Cola', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1129', name_ja: 'グリーン・ドラゴン', name_en: 'Green Dragon', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'グリーンリキュール、ジンジャーソーダ', notes_en: 'Green Liqueur, Ginger Soda Juice', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1130', name_ja: 'ウィスキーソーダ (ハイボール)', name_en: 'Whiskey with Soda (Japanese Highball)', price: 850, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ウィスキー、ソーダ、レモン', notes_en: 'Whiskey, Soda, Lemon', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1131', name_ja: '梅酒ソーダ', name_en: 'Umeshu Soda (Plum Wine)', price: 950, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '加賀梅酒', notes_en: 'Plum Wine Kagaumeshu', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1132', name_ja: '梅酒ロック', name_en: 'Umeshu on the rocks (Plum Wine)', price: 950, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '加賀梅酒', notes_en: 'Plum Wine Kagaumeshu', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1211', name_ja: '赤ワイン (グラス 125ml)', name_en: 'Red Wine (Glass 125ml)', price: 650, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'グラスワイン', notes_en: 'Glass Wine', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1212', name_ja: '白ワイン (グラス 125ml)', name_en: 'White Wine (Glass 125ml)', price: 650, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'グラスワイン', notes_en: 'Glass Wine', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1311', name_ja: '菊姫 (日本酒 180ml)', name_en: 'Kikuhime (Sake 180ml)', price: 950, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '日本酒、アルコール度数:2.5', notes_en: 'Sake, Alcohol Bitterness Scale:2.5 (MAX 10)', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1312', name_ja: '池月 (日本酒 180ml)', name_en: 'Ikezuki (Sake 180ml)', price: 950, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '日本酒、アルコール度数:3.8', notes_en: 'Sake, Alcohol Bitterness Scale:3.8 (MAX 10)', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1313', name_ja: '手取川 (日本酒 180ml)', name_en: 'Tedorigawa (Sake 180ml)', price: 950, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '日本酒、アルコール度数:8.0', notes_en: 'Sake, Alcohol Bitterness Scale:8.0 (MAX 10)', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1314', name_ja: '加賀鳶 (日本酒 180ml)', name_en: 'Kagatobi (Sake 180 ml)', price: 950, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '日本酒、アルコール度数:8.5', notes_en: 'Sake, Alcohol Bitterness Scale:8.5 (MAX 10)', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1315', name_ja: '加賀鶴 (日本酒 180 ml)', name_en: 'Kagatsuru (Sake 180 ml)', price: 950, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '日本酒、アルコール度数:9.5', notes_en: 'Sake, Alcohol Bitterness Scale:9.5 (MAX 10)', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1411', name_ja: '白ワイン (ボトル) セリカデッロ・ゴデーリョ', name_en: 'Sericadello Godello y Dona Blanca (White Wine Bottle)', price: 3800, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ゴデーリョとドーニャブランカのブレンド。バターとローストナッツのヒントがある、フルーティーでクリーミーな味わい。', notes_en: 'A typical fish for this region consisting of Godello and Doña Blanca. This wine shows yellow that aromas with a hint of butter and roasted nuts, and a slight note of vanilla. The taste is full and creamy.', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1412', name_ja: '白ワイン (ボトル) FREDDO ARANCIO', name_en: 'FREDDO ARANCIO Inzolia (White Wine Bottle)', price: 3800, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'シチリア産。桃とアプリコットの香りがスムーズに溶け込む、フルーティーでエレガントな白ワイン。', notes_en: 'Notes of peach and apricot blend smoothly in Sicily and tradition. Harmonious and elegant white wine - this fine mix, which surprises with its fruity elegance. Fresh and mineral.', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1413', name_ja: '白ワイン (ボトル) シャブリ', name_en: 'Chef Selectas Chablis (White Wine Bottle)', price: 7600, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'フランス、ブルゴーニュ地方の辛口白ワイン。シャープで刺激的なシャルドネのワイン。', notes_en: 'Chablis is a dry wine made in Burgundy, France and it is made in the Chablis district. It is a crisp wine that has such stimulating the chardonnay grapes. Chablis is never sweet.', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1414', name_ja: '赤ワイン (ボトル) モンテプルチアーノ・ダブルッツォ (ミディアム)', name_en: 'Domodo Montepulciano d\'Abruzzo (Red Wine Medium body)', price: 3800, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'オーガニックのイタリアンワイン。ミディアムボディでフルーティーな味わい。', notes_en: 'It is an organic Italian wine, medium fruit taste.', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1415', name_ja: '赤ワイン (ボトル) コート・デュ・ローヌ (フルボディ)', name_en: 'Cotes du Rhone Vieilles Vignes (Red Wine Full body)', price: 6200, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'クラシックな南ローヌの特徴を示すフルボディの赤。ブラックフルーツとリコリスのヒント、長い余韻。', notes_en: 'A full-bodied red showing classic southern Rhone characters. Layered with black fruit, hints of liquorice and a long finish. Pair with black pepper and boldly fierce. Smooth and assertive.', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1416', name_ja: '赤ワイン (ボトル) バロッサ・シラーズ (フルボディ)', name_en: 'Peter Lehmann BAROSSAN SHIRAZ (Red Wine Full body)', price: 8900, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'フレンチ＆アメリカンオークで12ヶ月熟成されたフルボディ。チョコレートとモカの甘いノートが豊富。', notes_en: 'A full-bodied wine aged for 12 months in French and American oak barrels. It is intense and richly layered with sweet notes of chocolate and mocha, and the characteristic sweetness of the Barossa.', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1417', name_ja: 'スパークリングワイン (ボトル) フレシネ・コルドン・ネグロ', name_en: 'Freixenet X Cava (Sparkling Wine & Champagne)', price: 3800, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'カバ (スペインのスパークリングワイン)。シャンパンと同じ製法で造られた、クリスプでバランスの取れた味わい。', notes_en: 'Cava is a Spanish sparkling wine. A crisp, clean and well-balanced Cava, Freixenet Cava is made with the same method as Champagne. It may bring a long finish and an exciting rush of orange.', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1511', name_ja: '抹茶 (ホット)', name_en: 'Matcha Green Tea (Hot)', price: 800, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '日本の伝統的な抹茶。調理済みの温かい飲み物。', notes_en: 'The traditional Japanese style Green Tea. Please ask for details.', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '1512', name_ja: 'ジャスミン茶 (ホット)', name_en: 'Jasmine Tea (Hot)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '温かい飲み物', notes_en: 'Hot Drink', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '1513', name_ja: '緑茶 (ホット)', name_en: 'Green Tea (Hot)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '温かい飲み物', notes_en: 'Hot Drink', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '1514', name_ja: 'ウーロン茶 (ホット)', name_en: 'Oolong Tea (Hot)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '温かい飲み物', notes_en: 'Hot Drink', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '1515', name_ja: 'ジャスミン茶 (ホット)', name_en: 'Jasmine Tea (Hot)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '温かい飲み物', notes_en: 'Hot Drink', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '1516', name_ja: '日本式ジャスミン茶 (ホット)', name_en: 'Japanese Jasmine Tea (Hot)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '温かい飲み物', notes_en: 'Hot Drink', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '1517', name_ja: '英国風紅茶 (ホット)', name_en: 'English Tea (Hot)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ブラックティー、英国式', notes_en: 'Black tea, British-style tea.', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '1518', name_ja: 'ブレンドコーヒー (ホット)', name_en: 'Blended Coffee (Hot)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '温かい飲み物', notes_en: 'Hot Drink', isVegan: true, isCooked: false, hasAllergens: false }, // コーヒーは通常ビーガン
            { code: '1611', name_ja: 'コカ・コーラ', name_en: 'Coca Cola', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '冷たい飲み物', notes_en: 'Cold Drink', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1612', name_ja: 'コカ・コーラ ゼロ', name_en: 'Coca Cola ZERO', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '冷たい飲み物', notes_en: 'Cold Drink', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1613', name_ja: 'ジンジャーエール', name_en: 'Ginger ale', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '冷たい飲み物', notes_en: 'Cold Drink', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1614', name_ja: 'ファンタ オレンジ', name_en: 'Fanta Orange', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '冷たい飲み物', notes_en: 'Cold Drink', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1615', name_ja: 'オレンジジュース', name_en: 'Orange Juice', price: 600, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '冷たい飲み物', notes_en: 'Cold Drink', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1616', name_ja: 'ミルク (アイス)', name_en: 'Milk (Iced)', price: 600, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '冷たい飲み物、乳製品', notes_en: 'Cold Drink, Dairy', isVegan: false, isCooked: false, hasAllergens: true }, 
            { code: '1617', name_ja: 'ウーロン茶 (アイス)', name_en: 'Oolong Tea (Iced)', price: 450, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: '冷たい飲み物', notes_en: 'Cold Drink', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1711', name_ja: 'アサヒ ドライゼロ (ノンアルコール)', name_en: 'Asahi ZERO (Non‑alcohol Beer)', price: 550, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ノンアルコールビール', notes_en: 'Non‑alcohol', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1712', name_ja: '天然水 500ml', name_en: 'Natural Mineral Water 500ml', price: 350, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ボトル', notes_en: 'Bottle', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1713', name_ja: '炭酸水 500ml', name_en: 'Carbonated Water 500ml', price: 350, category_ja: 'ドリンク', category_en: 'Drink', notes_ja: 'ボトル', notes_en: 'Bottle', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '1811', name_ja: 'チョコレートアイスクリーム', name_en: 'Chocolate Ice Cream', price: 500, category_ja: 'デザート', category_en: 'Dessert', notes_ja: '乳製品、卵を含む', notes_en: 'Dessert, Contains dairy, eggs', isVegan: false, isCooked: false, hasAllergens: true }, 
            { code: '1812', name_ja: 'バニラアイスクリーム', name_en: 'Vanilla Ice Cream', price: 500, category_ja: 'デザート', category_en: 'Dessert', notes_ja: '乳製品、卵を含む', notes_en: 'Dessert, Contains dairy, eggs', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '2111', name_ja: '刺身盛り合わせ', name_en: 'Sashimi Moriawase', price: 2800, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '板長おまかせの刺身', notes_en: 'Chef\'s choice sashimi', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '2112', name_ja: '和牛ステーキ (約150g)', name_en: 'Wagyu Stake (about 150g)', price: 5500, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '牛肉', notes_en: 'Beef', isVegan: false, isCooked: true, hasAllergens: false },
            { code: '2113', name_ja: 'カニ味噌汁', name_en: 'Kani-miso Soup', price: 1150, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '蟹味噌使用', notes_en: 'Soup, Crab miso', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '2114', name_ja: '枝豆', name_en: 'Edamame', price: 550, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '若採り大豆の茹でたて', notes_en: 'Young soybeans typically boiled and salted.', isVegan: true, isCooked: true, hasAllergens: false }, 
            { code: '2115', name_ja: '揚げ出し豆腐', name_en: 'Agedashi Tofu', price: 650, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '揚げ豆腐。だしに魚介類、小麦が含まれる可能性あり。', notes_en: 'Deep-fried Tofu. Broth may contain seafood and wheat.', isVegan: true, isCooked: true, hasAllergens: true },
            { code: '2116', name_ja: '冷奴', name_en: 'Hiyayakko (Cold Tofu)', price: 450, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '冷たい豆腐。醤油/タレに注意。', notes_en: 'Cold Tofu. Be mindful of soy sauce/sauce.', isVegan: true, isCooked: false, hasAllergens: true },
            { code: '2117', name_ja: '焼ききのこ', name_en: 'Grilled Mushrooms', price: 650, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: 'グリル調理', notes_en: 'Grilled preparation', isVegan: true, isCooked: true, hasAllergens: true },
            { code: '2118', name_ja: 'ナス天', name_en: 'Nasu Ten (Eggplant)', price: 800, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: 'ナスの天ぷら。小麦、揚げ油を使用。', notes_en: 'Eggplant tempura. Contains wheat and frying oil.', isVegan: true, isCooked: true, hasAllergens: true },
            { code: '2119', name_ja: 'アボカドミックスサラダ', name_en: 'Avocado Mix Salad', price: 1800, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: 'ドレッシングに注意', notes_en: 'Be mindful of the dressing', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '2120', name_ja: 'ロスティ (スイス風ハッシュドポテト)', name_en: 'Rosti (Swiss Hash Browns)', price: 1500, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '加熱調理', notes_en: 'Cooked preparation', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '2121', name_ja: 'サーモンカルパッチョ', name_en: 'Salmon Carpaccio', price: 2400, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '生魚', notes_en: 'Raw fish', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '2122', name_ja: '海老のバターソテー', name_en: 'Shrimp Butter Saute', price: 1700, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '海老、バター使用', notes_en: 'Shrimp, butter used', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '2123', name_ja: '帆立のバターソテー', name_en: 'Scallop Butter Saute', price: 1850, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '帆立、バター使用', notes_en: 'Scallop, butter used', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3111', name_ja: '金沢和牛ゴールドロール', name_en: 'KANAZAWA Wagyu Gold Roll', price: 5800, category_ja: '巻物', category_en: 'Roll', notes_ja: '24K金箔、和牛、アボカド、チーズ、きゅうり。調理済み。', notes_en: '24k gold, wagyu beef, avocado, cheese, cucumber. Cooked.', isVegan: false, isCooked: true, hasAllergens: true }, 
            { code: '3112', name_ja: 'グリーンタイガーロール', name_en: 'Green Tiger Roll', price: 2850, category_ja: '巻物', category_en: 'Roll', notes_ja: '海老天ぷら、アボカド、スパイシーツナ、きゅうり', notes_en: 'Prawn Tempura, Avocado, Spicy Tuna, Cucumber', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3113', name_ja: 'ドラゴンロール', name_en: 'Dragon Roll', price: 3100, category_ja: '巻物', category_en: 'Roll', notes_ja: '鰻、アボカド、カニカマ、きゅうり、卵サラダ', notes_en: 'Eel, Avocado, Surimi, Cucumber, Egg salad', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3114', name_ja: '海老サラダロール', name_en: 'Ebi Salad Roll', price: 2200, category_ja: '巻物', category_en: 'Roll', notes_ja: '海老天ぷら、海老、きゅうり、サラダ', notes_en: 'Shrimp Tempura, Shrimp, Cucumber, Salad', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3115', name_ja: 'キャタピラーロール', name_en: 'Caterpillar Roll', price: 2400, category_ja: '巻物', category_en: 'Roll', notes_ja: 'アボカド、カニカマ、きゅうり、とびこトッピング', notes_en: 'Avocado, Surimi, Cucumber; flying fish roes as topping', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3116', name_ja: 'アトランティックロール', name_en: 'Atlantic Roll', price: 2300, category_ja: '巻物', category_en: 'Roll', notes_ja: 'アボカド、カニカマ、きゅうり、サーモン', notes_en: 'Avocado, Surimi, Cucumber, Salmon', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3211', name_ja: 'ツナラバーロール', name_en: 'Tuna lover Roll', price: 2800, category_ja: '巻物', category_en: 'Roll', notes_ja: 'ツナ、きゅうり', notes_en: 'Tuna, Cucumber', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3212', name_ja: 'サーモンラバーロール', name_en: 'Salmon lover Roll', price: 2500, category_ja: '巻物', category_en: 'Roll', notes_ja: 'サーモン、きゅうり', notes_en: 'Salmon, Cucumber', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3213', name_ja: 'レインボーロール', name_en: 'Rainbow Roll', price: 2400, category_ja: '巻物', category_en: 'Roll', notes_ja: 'アボカド、カニカマ、きゅうり、様々なトッピング', notes_en: 'Avocado, Surimi, Cucumber; various topping', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3214', name_ja: 'フィッシュパーティロール', name_en: 'Fish Party Roll', price: 2600, category_ja: '巻物', category_en: 'Roll', notes_ja: '様々な鮮魚', notes_en: 'Various fresh fish', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3215', name_ja: 'アラスカロール', name_en: 'Alaska Roll', price: 2500, category_ja: '巻物', category_en: 'Roll', notes_ja: 'アボカド、カニカマ、きゅうり、サーモン', notes_en: 'Avocado, Surimi, Cucumber; Salmon', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3216', name_ja: 'サーモンフィラデルフィアロール', name_en: 'Salmon Philadelphia Roll', price: 2400, category_ja: '巻物', category_en: 'Roll', notes_ja: 'クリームチーズ、サーモン、アボカド、きゅうり', notes_en: 'Cream cheese, Salmon, Avocado, Cucumber', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3217', name_ja: 'スパイシーツナホタテロール', name_en: 'Spicy Tuna Scallop Roll', price: 2600, category_ja: '巻物', category_en: 'Roll', notes_ja: 'スパイシーツナ、チリホタテ', notes_en: 'Spicy tuna, Scallop with chili', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3218', name_ja: 'ホタテロール', name_en: 'Scallop Roll', price: 2500, category_ja: '巻物', category_en: 'Roll', notes_ja: 'アボカド、カニカマ、きゅうり、ホタテ', notes_en: 'Avocado, Surimi, Cucumber, Scallop', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3219', name_ja: 'タイガーロール', name_en: 'Tiger Roll', price: 2400, category_ja: '巻物', category_en: 'Roll', notes_ja: 'アボカド、海老、きゅうり', notes_en: 'Avocado, Shrimp, Cucumber', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '3311', name_ja: 'スパイダーロール', name_en: 'Spider Roll', price: 2950, category_ja: '巻物', category_en: 'Roll', notes_ja: 'ソフトシェルクラブ、マヨネーズ', notes_en: 'Soft shell crab, mayo', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3312', name_ja: 'テリマヨサーモンロール', name_en: 'Terri-mayo Salmon Roll', price: 2400, category_ja: '巻物', category_en: 'Roll', notes_ja: '焼ききのこ、きゅうり、サーモン、照り焼きマヨ', notes_en: 'Grilled mushroom, cucumber, salmon, teriyaki mayo', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3313', name_ja: '天ぷらロール', name_en: 'Tempura Roll', price: 2700, category_ja: '巻物', category_en: 'Roll', notes_ja: '各種魚介と野菜の天ぷら', notes_en: 'Various seafood & vegetable tempura', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3314', name_ja: 'エビ天クランチロール', name_en: 'Ebiten Crunch Roll', price: 2000, category_ja: '巻物', category_en: 'Roll', notes_ja: '海老天ぷら、クランチ天かす', notes_en: 'Prawn Tempura, Crunch Tempura', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '3411', name_ja: 'ベジ・キャタピラーロール', name_en: 'Vege‑Caterpillar Roll', price: 2800, category_ja: '巻物', category_en: 'Roll', notes_ja: '炒めたネギ、きのこ、サラダ', notes_en: 'Sautéed green onions, mushrooms, salad', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '3412', name_ja: 'ベジ・冷奴', name_en: 'Vege - Hiyayakko', price: 450, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '冷たい新鮮な豆腐', notes_en: 'Cold fresh tofu', isVegan: true, isCooked: false, hasAllergens: true },
            { code: '3413', name_ja: '揚げ出し豆腐 (ビーガン)', name_en: 'Agedashi Tofu', price: 650, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: 'きのこベースの出汁を使った揚げ豆腐', notes_en: 'Deep-fried Tofu with Mushroom-based dashi sauce', isVegan: true, isCooked: true, hasAllergens: true },
            { code: '3414', name_ja: 'ミニグリーンサラダ', name_en: 'Mini-Green Salad', price: 800, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '小さな野菜サラダ。ドレッシングに注意。', notes_en: 'Small plate of vegetable salad', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '3415', name_ja: 'ベジ・天ぷらロール', name_en: 'Vege‑Tempura Roll', price: 2700, category_ja: '巻物', category_en: 'Roll', notes_ja: '野菜の天ぷらロール。小麦を使用。', notes_en: 'Vegetable tempura', isVegan: true, isCooked: true, hasAllergens: true },
            { code: '3416', name_ja: 'ご飯 (石川県産)', name_en: 'Gohan (Rice)', price: 450, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '白米。石川県産。', notes_en: 'White Rice. These rice are product of Ishikawa prefecture', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '3417', name_ja: '枝豆 (ビーガン)', name_en: 'Edamame', price: 550, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '若採り大豆を茹でて塩を振ったもの。', notes_en: 'Young soybeans typically boiled and salted.', isVegan: true, isCooked: true, hasAllergens: false },
            { code: '3511', name_ja: '吸い物', name_en: 'Sumashi Jiru', price: 900, category_ja: '前菜/一品', category_en: 'Appetizer', notes_ja: '伝統的な日本の魚だしスープ', notes_en: 'Traditional Japanese fish broth soup', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '4111', name_ja: 'にぎり寿司セット (6貫)', name_en: 'Nigiri Sushi Set (6)', price: 3100, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '板長おまかせ', notes_en: 'Chef\'s selection', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4112', name_ja: 'トロ握り', name_en: 'Toro Nigiri', price: 800, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '大トロ/中トロ', notes_en: 'Fatty tuna', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4113', name_ja: 'マグロ握り', name_en: 'Tuna Nigiri', price: 600, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '赤身', notes_en: 'Tuna', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4114', name_ja: 'サーモン握り', name_en: 'Salmon Nigiri', price: 550, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '生サーモン', notes_en: 'Salmon', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4115', name_ja: 'ハマチ握り', name_en: 'Hamachi Nigiri', price: 600, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: 'ハマチ', notes_en: 'Yellow tail', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4116', name_ja: 'かいわれ握り', name_en: 'Kaiware Nigiri', price: 200, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '大根の新芽', notes_en: 'Radish sprouts', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '4117', name_ja: '生海老握り', name_en: 'Namaebi Nigiri', price: 550, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '生海老', notes_en: 'Raw shrimp', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4118', name_ja: '蒸し海老握り', name_en: 'Mushi‑ebi Nigiri', price: 550, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '蒸し海老', notes_en: 'Steamed shrimp', isVegan: false, isCooked: true, hasAllergens: true },
            { code: '4119', name_ja: 'ホタテ握り', name_en: 'Hotate Nigiri', price: 600, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: 'ホタテ貝', notes_en: 'Scallop', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4120', name_ja: 'スパイシーツナ軍艦', name_en: 'Spicy Tuna Gunkan', price: 550, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: 'スパイシーなマグロのたたき', notes_en: 'Spicy Tuna Tartare', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4211', name_ja: '太巻き', name_en: 'Futo Maki', price: 2500, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: '魚介類とサラダの太巻き', notes_en: 'Thick roll with seafood and salad', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4311', name_ja: 'かっぱ巻き', name_en: 'Kappa Maki', price: 450, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: 'きゅうりの細巻', notes_en: 'Cucumber thin roll', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '4312', name_ja: 'アボカド細巻き', name_en: 'Avocado Hosomaki', price: 550, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: 'アボカドの細巻', notes_en: 'Avocado thin roll', isVegan: true, isCooked: false, hasAllergens: false },
            { code: '4313', name_ja: '鉄火巻き', name_en: 'Tekka Maki', price: 650, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: 'マグロの細巻', notes_en: 'Tuna thin roll', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '4314', name_ja: 'サーモン細巻き', name_en: 'Salmon Hosomaki', price: 600, category_ja: 'にぎり', category_en: 'Nigiri', notes_ja: 'サーモンの細巻', notes_en: 'Salmon thin roll', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '5001', name_ja: '抹茶アイスクリーム', name_en: 'Matcha Ice Cream', price: 700, category_ja: 'デザート', category_en: 'Dessert', notes_ja: '京都産抹茶使用。乳製品、卵を含む。', notes_en: 'Made with Kyoto Matcha. Contains dairy, eggs.', isVegan: false, isCooked: false, hasAllergens: true },
            { code: '5002', name_ja: 'フルーツ盛り合わせ (ビーガン)', name_en: 'Fruit Platter (Vegan)', price: 900, category_ja: 'デザート', category_en: 'Dessert', notes_ja: '旬のフルーツ', notes_en: 'Seasonal fruits', isVegan: true, isCooked: false, hasAllergens: false },
        ];

    // ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐ ⭐


    // ------------------------------------------------------
    // II. UI制御とロジック関数
    // ------------------------------------------------------

    /**
     * 翻訳テキストを取得
     */
    function getText(key) {
        return TEXTS[key] ? TEXTS[key][currentLang] : key;
    }

    /**
     * 数値を通貨形式にフォーマット
     */
    function formatCurrency(amount) {
        const formatter = new Intl.NumberFormat(currentLang === 'ja' ? 'ja-JP' : 'en-US', {
            style: 'currency',
            currency: 'JPY', // 日本円表示に統一
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });
        return formatter.format(amount);
    }

    /**
     * メッセージモーダルを表示
     */
    function showMessage(text, type = 'success') {
        const modal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        
        messageText.textContent = text;
        
        if (type === 'success') {
            modal.style.backgroundColor = '#ecfdf5'; // 緑系の薄い背景
            messageText.style.color = '#059669';    // 緑系の文字
        } else {
            modal.style.backgroundColor = '#fee2e2'; // 赤系の薄い背景
            messageText.style.color = '#dc2626';    // 赤系の文字
        }
        
        modal.style.display = 'block';
    }

    /**
     * カートの数量を更新
     */
    function updateQuantity(productId, change) {
        const product = products.find(p => p.code === productId);
        if (!product) return;

        if (cart[productId]) {
            cart[productId].quantity += change;
        } else if (change > 0) {
            cart[productId] = { 
                product: product, 
                quantity: change, 
                price: product.price 
            };
        }

        if (cart[productId] && cart[productId].quantity <= 0) {
            delete cart[productId];
        }

        renderProductList();
        updateTotal();
    }

    /**
     * カートをクリア
     */
    function clearCart() {
        if (Object.keys(cart).length === 0) return;

        if (confirm(getText('confirm_clear'))) {
            cart = {};
            renderAllUI();
        }
    }
    
    /**
     * ビーガンフィルタの切り替え
     */
    function toggleVeganFilter() {
        isVeganFilterActive = !isVeganFilterActive;
        currentCategory = getText('category_all'); // フィルタ変更時はカテゴリを「すべて」に戻す
        renderAllUI();
    }

    /**
     * テーブルを選択し、メインメニューを表示する
     */
    function selectTable(table) {
        currentTable = table;
        const overlay = document.getElementById('table-modal-overlay');
        const mainContent = document.getElementById('main-content');
        const mainFooter = document.getElementById('main-footer');

        // モーダルを非表示にし、メインコンテンツを表示
        overlay.style.display = 'none';
        mainContent.style.display = 'block';
        mainFooter.style.display = 'block';

        // UIを初期化・更新
        renderAllUI(); 
    }

    /**
     * テーブル選択モーダルを表示し、テーブルボタンを描画する
     */
    function showTableModal() {
        const modalOverlay = document.getElementById('table-modal-overlay');
        const grid = document.getElementById('table-selection-grid');
        const mainContent = document.getElementById('main-content');
        const mainFooter = document.getElementById('main-footer');
        
        // 既にテーブルが選択されている場合はスキップ
        if (currentTable) {
            modalOverlay.style.display = 'none';
            mainContent.style.display = 'block';
            mainFooter.style.display = 'block';
            return;
        }

        // 1. メインコンテンツを非表示にする
        mainContent.style.display = 'none';
        mainFooter.style.display = 'none';
        
        // 2. モーダルを表示する (CSSの display: flex で表示を確定)
        modalOverlay.style.display = 'flex'; 
        
        // 3. ボタンの描画ロジック
        if (grid) {
            grid.innerHTML = '';
            TABLES.forEach(tableId => {
                const button = document.createElement('button');
                button.textContent = tableId;
                button.className = `bg-primary-blue text-white font-bold text-2xl py-4 rounded-xl shadow-lg hover:bg-primary-hover transition duration-150 ease-in-out`;
                button.onclick = () => selectTable(tableId);
                grid.appendChild(button);
            });
        }
        
        document.getElementById('full-header-title').textContent = getText('select_table_title');
    }

    /**
     * 言語を切り替える
     */
    function toggleLanguage() {
        currentLang = currentLang === 'ja' ? 'en' : 'ja';
        currentCategory = getText('category_all');
        isVeganFilterActive = false; 
        currentTipRate = TIP_RATES[0]; 
        
        renderAllUI();
    }

    /**
     * 画面上部の静的要素（ヘッダー、カートボタンのテキストなど）を更新
     */
    function renderStaticElements() {
        // ヘッダータイトル（テーブルID表示）
        if (currentTable) {
            document.getElementById('full-header-title').innerHTML = 
                `${getText('table_display')} ${currentTable} ${getText('header_title')}`;
        } else {
            document.getElementById('full-header-title').textContent = getText('select_table_title');
        }

        // 言語切り替えボタン
        document.getElementById('lang-button').textContent = currentLang === 'ja' ? 'EN' : '日本語';

        // その他の静的なHTML要素のテキスト更新
        document.getElementById('cart-subtotal-label').textContent = getText('subtotal');
        document.getElementById('cart-tax-label').textContent = getText('tax');
        document.getElementById('cart-tip-label').textContent = getText('tip');
        document.getElementById('cart-total-label').textContent = getText('total');
        document.getElementById('send-order-button').textContent = getText('send_order');
        document.getElementById('notes-label').textContent = getText('notes_label');
        document.getElementById('clear-cart-button').textContent = getText('clear_cart');

        // 注釈の更新
        document.getElementById('notes-input').placeholder = getText('notes_placeholder');
    }

    /**
     * フィルタリングコントロール（ビーガン、ソート）を更新
     */
    function renderFilterControls() {
        const veganButton = document.getElementById('vegan-filter-button');
        veganButton.textContent = getText('filter_vegan');
        
        // ビーガンフィルタボタンのスタイル更新
        if (isVeganFilterActive) {
            veganButton.classList.add('bg-green-600', 'text-white');
            veganButton.classList.remove('bg-gray-200', 'text-gray-700');
        } else {
            veganButton.classList.add('bg-gray-200', 'text-gray-700');
            veganButton.classList.remove('bg-green-600', 'text-white');
        }
    }

    /**
     * カテゴリタブをレンダリング/更新
     */
    function renderCategoryTabs() {
        const categories = [getText('category_all'), ...new Set(products.map(p => p[`category_${currentLang}`]))];
        const container = document.getElementById('category-tabs');
        if (!container) return; // 要素がない場合はスキップ
        
        container.innerHTML = '';

        categories.forEach(category => {
            const button = document.createElement('button');
            button.textContent = category;
            button.className = `category-tab px-4 py-2 rounded-full font-medium transition duration-150 ease-in-out whitespace-nowrap text-sm`;
            
            if (category === currentCategory) {
                button.classList.add('bg-soft-red', 'text-white');
            } else {
                button.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
            }
            
            button.onclick = () => {
                currentCategory = category;
                renderAllUI();
            };
            container.appendChild(button);
        });
    }

    /**
     * 現在のフィルタとカテゴリに基づき商品リストをレンダリング
     */
    function renderProductList() {
        const container = document.getElementById('product-list');
        if (!container) return;

        container.innerHTML = '';
        
        if (products.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 p-8">商品データが読み込まれていません。</p>`;
            return;
        }

        // フィルタリングロジック
        const filteredProducts = products.filter(product => {
            const categoryMatch = currentCategory === getText('category_all') || 
                                  product[`category_${currentLang}`] === currentCategory;
            
            const veganMatch = !isVeganFilterActive || product.isVegan;

            return categoryMatch && veganMatch;
        });

        if (filteredProducts.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 p-8">${getText('not_found')}</p>`;
            return;
        }

        // 商品カードの描画
        filteredProducts.forEach(product => {
            const productId = product.code;
            const currentQty = cart[productId] ? cart[productId].quantity : 0;
            
            // アイコンのHTMLを生成
            const iconHtml = `
                ${product.isVegan ? `<span title="${getText('icon_vegan')}" class="text-icon-green text-lg mr-2">🟢</span>` : ''}
                ${product.isCooked ? `<span title="${getText('icon_cooked')}" class="text-icon-yellow text-lg mr-2">🟡</span>` : ''}
                ${product.hasAllergens ? `<span title="${getText('icon_allergy')}" class="text-icon-red text-lg">🔴</span>` : ''}
            `;

            const card = document.createElement('div');
            card.className = "bg-white p-4 rounded-xl shadow-lg flex items-center justify-between";
            card.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="placeholder.jpg" alt="${product[`name_${currentLang}`]}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                    <div>
                        <h3 class="font-semibold text-gray-900">${product[`name_${currentLang}`]}</h3>
                        <p class="text-sm text-gray-500">${product.notes_ja}</p>
                        <p class="text-sm font-bold text-gray-700 mt-1">${formatCurrency(product.price)}</p>
                        <div class="mt-1">${iconHtml}</div>
                    </div>
                </div>
                
                <div class="flex-shrink-0">
                    <div class="flex items-center space-x-2">
                        <button onclick="updateQuantity('${productId}', -1)" 
                                class="qty-btn bg-gray-200 text-gray-700 hover:bg-gray-300 ${currentQty > 0 ? '' : 'opacity-50 cursor-not-allowed'}" 
                                ${currentQty > 0 ? '' : 'disabled'}>
                            -
                        </button>
                        <span id="qty-${productId}" class="text-xl font-bold w-10 text-center">
                            ${currentQty}
                        </span>
                        <button onclick="updateQuantity('${productId}', 1)" 
                                class="qty-btn bg-soft-red text-white hover:bg-red-600">
                            +
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    /**
     * チップ選択ボタンのレンダリング
     */
    function renderTipButtons() {
        const container = document.getElementById('tip-buttons');
        if (!container) return;
        
        container.innerHTML = '';
        
        TIP_RATES.forEach(rate => {
            const button = document.createElement('button');
            const percentage = rate * 100;
            button.textContent = `${percentage}%`;
            button.className = 'tip-button';
            
            if (rate === currentTipRate) {
                button.classList.add('tip-selected');
            }
            
            button.onclick = () => {
                currentTipRate = rate;
                renderAllUI();
            };
            container.appendChild(button);
        });
    }

    /**
     * カートの合計を更新し、画面に反映
     */
    function updateTotal() {
        let subtotal = 0;
        let totalQuantity = 0;
        
        // 小計と合計数量を計算
        Object.values(cart).forEach(item => {
            subtotal += item.price * item.quantity;
            totalQuantity += item.quantity;
        });

        // 税金とチップを計算
        const tax = subtotal * TAX_RATE;
        const tip = subtotal * currentTipRate;
        const total = subtotal + tax + tip;

        // 画面に反映
        document.getElementById('cart-subtotal-value').textContent = formatCurrency(subtotal);
        document.getElementById('cart-tax-value').textContent = formatCurrency(tax);
        document.getElementById('cart-tip-value').textContent = formatCurrency(tip);
        document.getElementById('cart-total-value').textContent = formatCurrency(total);
        
        document.getElementById('cart-quantity-indicator').textContent = totalQuantity;

        // 注文送信ボタンの有効化/無効化
        const sendButton = document.getElementById('send-order-button');
        if (totalQuantity > 0) {
            sendButton.disabled = false;
            sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    
    /**
     * 全てのUIコンポーネントをレンダリング/更新
     */
    function renderAllUI() {
        renderStaticElements();
        renderFilterControls();
        renderCategoryTabs();
        renderProductList();
        renderTipButtons(); 
        updateTotal(); 
    }
    
    /**
     * 注文データをFirebase Realtime Databaseに送信する
     */
    function sendOrder() {
        if (Object.keys(cart).length === 0 || !currentTable) return;
        
        const orderItems = Object.values(cart).map(item => ({
            code: item.product.code,
            name_ja: item.product.name_ja,
            name_en: item.product.name_en,
            quantity: item.quantity,
            price: item.price,
            subtotal: item.price * item.quantity
        }));

        let subtotal = 0;
        Object.values(cart).forEach(item => { subtotal += item.price * item.quantity; });
        const tax = subtotal * TAX_RATE;
        const tip = subtotal * currentTipRate;
        const total = subtotal + tax + tip;

        const orderData = {
            table: currentTable,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            status: 'NEW',
            subtotal: subtotal,
            tax: tax,
            tip: tip,
            total: total,
            notes: document.getElementById('notes-input').value,
            items: orderItems
        };

        const newOrderRef = db.ref('orders').push();
        newOrderRef.set(orderData)
            .then(() => {
                // 成功時の処理
                showMessage(getText('message_sent_success'), 'success');
                cart = {}; // カートをクリア
                document.getElementById('notes-input').value = ''; // 備考欄をクリア
                renderAllUI();
                
                // 送信後にボタンを無効化
                const sendButton = document.getElementById('send-order-button');
                sendButton.disabled = true;
                sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            })
            .catch((error) => {
                // 失敗時の処理
                console.error("Firebase送信エラー:", error);
                showMessage(getText('message_sent_failure') + '\n' + error.message, 'error');
            });
    }

    // ------------------------------------------------------
    // III. 初期化処理
    // ------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        // 初期カテゴリを設定
        currentCategory = getText('category_all');
        
        // 初回ロード時にテーブル選択モーダルを表示 (テーブル選択までメインコンテンツは隠れている)
        showTableModal(); 
    });
</script>

</body>
</html>

