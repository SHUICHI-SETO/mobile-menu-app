<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>モバイル注文メニュー | T1-T6テーブル対応</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントの設定と基本スタイル */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #eef1f5; 
        }
        
        /* カスタムカラー設定 */
        .bg-primary-blue { background-color: #3b82f6; } /* 青 */
        .hover\:bg-primary-hover:hover { background-color: #2563eb; } /* 濃い青 */
        .text-primary-blue { color: #3b82f6; }
        .bg-icon-green { background-color: #10b981; } /* 緑 */
        .text-icon-green { color: #10b981; }
        .text-icon-yellow { color: #f59e0b; } /* 黄 */
        .bg-soft-red { background-color: #ef4444; } /* 赤 */

        /* チップ選択ボタンのカスタムスタイル */
        .tip-label { flex-grow: 1; text-align: center; }
        .tip-button {
            display: block;
            padding: 8px 0; 
            font-size: 0.95rem; 
            font-weight: 600; 
            border-radius: 9999px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            color: #4b5563;
            width: 100%;
        }
        .tip-button.tip-selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5), 0 2px 4px -2px rgba(59, 130, 246, 0.5);
        }
        .tip-button.tip-unselected:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="table-modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" style="display: none;">
        <div id="table-modal-container" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            </div>
    </div>

    <header id="main-header" class="bg-white shadow-md sticky top-0 z-10 hidden">
        <div class="max-w-xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 id="full-header-title" class="text-xl font-extrabold text-gray-900">
                </h1>
            <button id="lang-toggle" class="text-sm font-semibold text-primary-blue" onclick="toggleLanguage()">
                </button>
        </div>
    </header>

    <main id="main-content" class="flex-grow pt-4 pb-4 px-4 overflow-auto hidden">
        <div class="max-w-xl mx-auto">
            
            <div class="mb-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800" id="menu-title">メニュー</h2>
                <button id="vegan-filter-button" 
                    class="flex items-center space-x-1 px-3 py-1.5 text-sm font-semibold rounded-full bg-gray-300 hover:bg-gray-400 transition-colors"
                    onclick="toggleVeganFilter()">
                    <span id="filter-label"></span>
                </button>
            </div>

            <div class="overflow-x-auto whitespace-nowrap py-2 mb-4">
                <div id="category-tabs" class="flex space-x-3">
                    </div>
            </div>

            <div id="product-list" class="space-y-3 pb-4">
                </div>
            
        </div>
    </main>

    <footer id="main-footer" class="bg-white shadow-2xl p-4 sticky bottom-0 z-10 hidden">
        <div class="max-w-xl mx-auto">
            
            <div class="flex justify-between items-center mb-3">
                <span id="item-count" class="text-sm font-semibold text-gray-600">
                    </span>
                <div id="message-area" class="text-xs font-semibold"></div>
            </div>

            <div class="px-4 py-2 text-center">
                <button id="tip-detail-toggle" class="text-xs text-gray-500 hover:text-gray-700 font-semibold mb-2" onclick="toggleTipDetails()">
                    </button>
            </div>

            <div id="tip-details-box" class="px-4 pb-2 hidden">
                <p id="tip-rate-label" class="text-sm font-semibold mb-2 text-gray-600 text-center">チップ率を選択してください:</p>
                
                <div id="tip-buttons" class="flex space-x-2 mb-4">
                    </div>

                <div class="flex justify-between items-center text-sm mb-1">
                    <span id="subtotal-label" class="text-gray-600">小計</span>
                    <span id="subtotal-amount" class="font-semibold text-gray-800">0円</span>
                </div>
                <div class="flex justify-between items-center text-sm mb-2 border-b pb-2">
                    <span id="tip-label" class="text-gray-600">チップ</span>
                    <span id="tip-amount" class="font-semibold text-primary-blue">0円</span>
                </div>
            </div>

            <div class="flex justify-between items-center text-xl font-extrabold mb-4 pt-2">
                <span id="total-label" class="text-gray-800">合計請求額</span>
                <span id="total-amount" class="text-primary-blue">0円</span>
            </div>

            <button id="order-btn" disabled 
                class="w-full py-4 text-xl font-bold rounded-xl shadow-lg transition-colors bg-gray-400 text-white cursor-not-allowed"
                onclick="sendOrder()">
                </button>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ------------------------------------------------------
        // I. 定数とグローバル変数の定義
        // ------------------------------------------------------
        const TABLES = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'];
        const TAX_RATE = 0.10; // 10% (未使用だが定義として残す)
        const TIP_RATES = [0, 10, 15, 20]; 
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // 状態管理
        let currentTable = null; 
        let currentLang = 'ja'; 
        let isVeganFilterActive = false;
        let currentCategory = 'すべて';
        let currentTipRate = TIP_RATES[0]; 
        let cart = {}; // カートの中身: { '商品コード': { product, quantity, price } }
        
        // UIテキストの多言語対応データ
        const TEXTS = {
            'ja': {
                header_title: 'の注文',
                header_subtitle: 'タッチして注文数を入力してください。',
                lang_button: 'English',
                menu_title: 'メニュー',
                filter_vegan: 'ビーガンのみ',
                category_all: 'すべて',
                footer_subtotal: '小計',
                footer_tip: 'チップ',
                footer_total: '合計請求額',
                footer_points_1: '点 (小計: ',
                footer_points_2: ')',
                footer_send: '注文を送信',
                detail_close: 'チップ/料金詳細を閉じる',
                detail_open: 'チップ/料金詳細を開く',
                tip_label: 'チップ率を選択してください:',
                tip_none: 'なし',
                message_error: 'エラー: カートに商品がありません。',
                message_sent_success: '注文がキッチンに送信されました！',
                message_sent_failure: '注文送信に失敗しました。',
                icon_vegan: 'ビーガン',
                icon_cooked: '調理済',
                icon_allergy: 'アレルギー',
                not_found: '該当する商品が見つかりませんでした。',
                image_text: '商品画像',
                select_table_title: 'テーブルを選択中...',
                table_display: 'テーブル:',
            },
            'en': {
                header_title: ' Order',
                header_subtitle: 'Tap to input the quantity.',
                lang_button: '日本語',
                menu_title: 'Menu',
                filter_vegan: 'Vegan Only',
                category_all: 'All',
                footer_subtotal: 'Subtotal',
                footer_tip: 'Tip',
                footer_total: 'Total Amount Due',
                footer_points_1: ' items (Subtotal: ',
                footer_points_2: ')',
                footer_send: 'Send Order',
                detail_close: 'Hide Tip/Fee Details',
                detail_open: 'Show Tip/Fee Details',
                tip_label: 'Select Tip Percentage:',
                tip_none: 'None',
                message_error: 'Error: Cart is empty.',
                message_sent_success: 'Order sent to the kitchen!',
                message_sent_failure: 'Order failed to send.',
                icon_vegan: 'Vegan',
                icon_cooked: 'Cooked',
                icon_allergy: 'Allergens',
                not_found: 'No matching products found.',
                image_text: 'Product Image',
                select_table_title: 'Selecting Table...',
                table_display: 'Table:',
            }
        };

        // Firebaseの設定
        const firebaseConfig = {
            apiKey: "AIzaSyBWVkm-z2b5Gc3NgaxRYqCArc3_1qGXt6M",
            authDomain: "atsushi-menu-order.firebaseapp.com",
            databaseURL: "https://atsushi-menu-order-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "atsushi-menu-order",
            storageBucket: "atsushi-menu-order.firebasestorage.app",
            messagingSenderId: "646826055037",
            appId: "1:646826055037:web:67b13209ccd675326ee814",
            measurementId: "G-ZL674LSY85"
        };
        
        // ------------------------------------------------------
        // II. UI制御とロジック関数
        // ------------------------------------------------------

        /**
         * 翻訳テキストを取得
         */
        function getText(key) {
            return TEXTS[currentLang][key] || key;
        }
        
        /**
         * メッセージ表示
         */
        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = text;
            messageArea.className = 'text-xs font-semibold transition-opacity duration-300';

            // スタイルの設定
            if (type === 'success') {
                messageArea.classList.add('text-icon-green');
            } else if (type === 'error') {
                messageArea.classList.add('text-soft-red');
            } else {
                messageArea.classList.add('text-gray-500');
            }

            // 一定時間後に非表示にする
            setTimeout(() => {
                messageArea.classList.remove('text-icon-green', 'text-soft-red', 'text-gray-500');
                messageArea.innerHTML = '';
            }, 3000);
        }

        /**
         * 商品IDから商品オブジェクトを取得
         */
        function findProductByCode(code) {
            return products.find(p => p.code === code);
        }
        
        /**
         * 指定カテゴリとビーガンフィルターに基づいて商品リストを取得
         */
        function getProductsByCategory(category, isVegan) {
            let filteredProducts = products;

            if (category !== getText('category_all')) {
                filteredProducts = filteredProducts.filter(p => p[`category_${currentLang}`] === category);
            }

            if (isVegan) {
                filteredProducts = filteredProducts.filter(p => p.isVegan);
            }
            
            return filteredProducts;
        }

        /**
         * カート内の商品を追加/更新
         */
        function updateCart(code, quantity) {
            if (quantity <= 0) {
                delete cart[code];
            } else {
                const product = findProductByCode(code);
                if (product) {
                    cart[code] = { 
                        product: product, 
                        quantity: quantity, 
                        price: product.price 
                    };
                }
            }
            // 商品リストを再レンダリングしないと、数量がすぐに反映されないため
            renderProductList(); 
            updateTotal();
        }

        /**
         * カート内商品の数量を増やす
         */
        function increaseQuantity(code) {
            const currentQty = cart[code] ? cart[code].quantity : 0;
            updateCart(code, currentQty + 1);
        }

        /**
         * カート内商品の数量を減らす
         */
        function decreaseQuantity(code) {
            const currentQty = cart[code] ? cart[code].quantity : 0;
            updateCart(code, currentQty - 1);
        }
        
        /**
         * 数値を通貨形式にフォーマット
         */
        function formatCurrency(amount) {
            const formatter = new Intl.NumberFormat(currentLang === 'ja' ? 'ja-JP' : 'en-US', {
                style: 'currency',
                currency: currentLang === 'ja' ? 'JPY' : 'USD', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(amount);
            
            return currentLang === 'ja' ? formatter.replace('¥', '') + '円' : formatter;
        }

        /**
         * チップ率の表示をフォーマット
         */
        function formatTipRate(rate) {
            return rate === 0 ? getText('tip_none') : `${rate}%`;
        }

        /**
         * 変更されない静的なUI要素をレンダリング（主に言語依存のテキスト）
         */
        function renderStaticElements() {
            // ヘッダーの言語切り替えボタン
            document.getElementById('lang-toggle').innerHTML = getText('lang_button');

            // サブヘッダーのテキストを更新 (テーブル選択後はテーブルIDが表示されます)
            const headerTitleElement = document.getElementById('full-header-title');
            if (headerTitleElement) {
                headerTitleElement.innerHTML = 
                    currentTable ? `${getText('table_display')} ${currentTable} ${getText('header_title')}` : getText('select_table_title');
            }
            
            // ビーガンフィルターのテキスト
            document.getElementById('filter-label').innerHTML = getText('filter_vegan');
            document.getElementById('menu-title').innerHTML = getText('menu_title');
            
            // フッターのテキスト
            document.getElementById('subtotal-label').innerHTML = getText('footer_subtotal');
            document.getElementById('tip-label').innerHTML = getText('footer_tip');
            document.getElementById('total-label').innerHTML = getText('footer_total');
            document.getElementById('order-btn').innerHTML = getText('footer_send');

            // チップ詳細のトグルボタンのテキストを現在の状態に応じて更新
            const detailsBox = document.getElementById('tip-details-box');
            const toggleButton = document.getElementById('tip-detail-toggle');
            
            if (toggleButton && detailsBox) {
                toggleButton.innerHTML = 
                    detailsBox.classList.contains('hidden') ? 
                    getText('detail_open') : getText('detail_close');
            }
            
            // チップ率選択の見出し
            document.getElementById('tip-rate-label').innerHTML = getText('tip_label');
        }

        /**
         * カート内の合計金額を計算
         */
        function calculateTotal() {
            let subtotal = 0;
            let itemCount = 0;
            for (const code in cart) {
                subtotal += cart[code].product.price * cart[code].quantity;
                itemCount += cart[code].quantity;
            }

            const tipAmount = Math.round(subtotal * (currentTipRate / 100));
            const total = subtotal + tipAmount;

            return { subtotal, tipAmount, total, itemCount };
        }

        /**
         * 合計金額を更新し、フッターをレンダリング
         */
        function updateTotal() {
            const totals = calculateTotal();
            const subtotalElement = document.getElementById('subtotal-amount');
            const tipElement = document.getElementById('tip-amount');
            const totalElement = document.getElementById('total-amount');
            const itemCountElement = document.getElementById('item-count');
            const orderBtn = document.getElementById('order-btn');

            if (!subtotalElement || !tipElement || !totalElement || !itemCountElement || !orderBtn) return;


            // 金額表示の更新
            subtotalElement.innerHTML = formatCurrency(totals.subtotal);
            tipElement.innerHTML = formatCurrency(totals.tipAmount);
            totalElement.innerHTML = formatCurrency(totals.total);
            
            // アイテム数の更新
            itemCountElement.innerHTML = `${totals.itemCount}${getText('footer_points_1')}${formatCurrency(totals.subtotal)}${getText('footer_points_2')}`;
            
            // 注文ボタンの制御
            if (totals.itemCount > 0) {
                orderBtn.disabled = false;
                orderBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                orderBtn.classList.add('bg-primary-blue', 'hover:bg-primary-hover');
            } else {
                orderBtn.disabled = true;
                orderBtn.classList.remove('bg-primary-blue', 'hover:bg-primary-hover');
                orderBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        /**
         * 言語切り替え
         */
        function toggleLanguage() {
            currentLang = currentLang === 'ja' ? 'en' : 'ja';
            // カテゴリ表示をリセット
            currentCategory = getText('category_all'); 
            renderAllUI();
        }

        /**
         * カテゴリタブのレンダリング
         */
        function renderCategoryTabs() {
            const tabContainer = document.getElementById('category-tabs');
            if (!tabContainer) return;

            // カテゴリのユニークなリストを取得 (現在の言語を使用)
            const categories = [...new Set(products.map(p => p[`category_${currentLang}`]))]; 
            categories.unshift(getText('category_all')); 

            let html = '';
            categories.forEach(category => {
                const isActive = category === currentCategory;
                const buttonClass = isActive
                    ? 'bg-primary-blue text-white'
                    : 'text-gray-600 hover:bg-gray-200';
                
                // onmousedown/ontouchstartでアクティブ化し、onclickでイベントを処理
                html += `
                    <button class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap transition-colors ${buttonClass}" 
                        onclick="selectCategory('${category.replace(/'/g, "\\'")}')">
                        ${category}
                    </button>
                `;
            });
            tabContainer.innerHTML = html;
        }

        /**
         * カテゴリ選択ハンドラ
         */
        function selectCategory(category) {
            currentCategory = category;
            renderProductList();
            renderCategoryTabs(); // 選択状態を更新
        }
        
        /**
         * ビーガンフィルターのレンダリング/制御
         */
        function renderFilterControls() {
            const filterButton = document.getElementById('vegan-filter-button');
            if (!filterButton) return;

            if (isVeganFilterActive) {
                filterButton.classList.remove('bg-gray-300', 'hover:bg-gray-400');
                filterButton.classList.add('bg-icon-green', 'text-white');
            } else {
                filterButton.classList.remove('bg-icon-green', 'text-white');
                filterButton.classList.add('bg-gray-300', 'hover:bg-gray-400');
            }
        }

        /**
         * ビーガンフィルターのトグル
         */
        function toggleVeganFilter() {
            isVeganFilterActive = !isVeganFilterActive;
            renderProductList();
            renderFilterControls();
        }

        /**
         * 商品リストのレンダリング
         */
        function renderProductList() {
            const listContainer = document.getElementById('product-list');
            if (!listContainer) return;

            const filteredProducts = getProductsByCategory(currentCategory, isVeganFilterActive);

            if (filteredProducts.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        ${getText('not_found')}
                    </div>
                `;
                return;
            }

            let html = '';
            filteredProducts.forEach(product => {
                const currentQty = cart[product.code] ? cart[product.code].quantity : 0;
                const name = product[`name_${currentLang}`] || product.name_ja;
                const notes = product[`notes_${currentLang}`] || product.notes_ja;

                // アイコンの生成
                let icons = '';
                if (product.isVegan) {
                    icons += `<span title="${getText('icon_vegan')}" class="text-icon-green">🌿</span>`;
                }
                if (product.isCooked) {
                    icons += `<span title="${getText('icon_cooked')}" class="text-icon-yellow">🔥</span>`;
                }
                if (product.hasAllergens) {
                    icons += `<span title="${getText('icon_allergy')}" class="text-soft-red">⚠️</span>`;
                }

                html += `
                    <div class="flex items-center bg-white p-3 rounded-xl shadow-sm space-x-3 mb-3" onclick="increaseQuantity('${product.code}')">
                        
                        <div class="flex-grow">
                            <div class="font-bold text-gray-800">${name}</div>
                            <div class="text-sm text-gray-500">${notes}</div>
                            <div class="text-lg font-bold text-primary-blue">${formatCurrency(product.price)}</div>
                        </div>

                        <div class="flex flex-col items-end space-y-2">
                            <div class="flex space-x-1 text-base">
                                ${icons}
                            </div>
                            
                            ${currentQty > 0 ? `
                                <div class="flex items-center space-x-1 bg-primary-blue text-white rounded-full p-1 shadow-md">
                                    <button class="w-6 h-6 flex items-center justify-center rounded-full bg-white text-primary-blue hover:bg-gray-100" 
                                            onclick="event.stopPropagation(); decreaseQuantity('${product.code}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                                    </button>
                                    <span class="font-semibold text-sm w-4 text-center text-white">${currentQty}</span>
                                    <button class="w-6 h-6 flex items-center justify-center rounded-full bg-white text-primary-blue hover:bg-gray-100" 
                                            onclick="event.stopPropagation(); increaseQuantity('${product.code}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                    </button>
                                </div>
                            ` : `
                                <button class="w-16 h-8 text-sm font-semibold text-gray-700 rounded-full border-2 border-gray-300 hover:bg-gray-100 transition-colors"
                                        onclick="event.stopPropagation(); increaseQuantity('${product.code}')">
                                    追加
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        /**
         * テーブル選択モーダルの表示
         */
        function showTableModal() {
            const overlay = document.getElementById('table-modal-overlay');
            const mainContent = document.getElementById('main-content');
            const mainFooter = document.getElementById('main-footer');
            const header = document.getElementById('main-header');
            const modalContainer = document.getElementById('table-modal-container');

            if (!overlay || !mainContent || !mainFooter || !header || !modalContainer) return;
            
            // モーダルのコンテンツをレンダリング
            let tableButtonsHtml = TABLES.map(table => 
                `<button class="w-24 h-24 bg-primary-blue text-white text-xl font-bold rounded-xl shadow-lg hover:bg-primary-hover transition-colors" onclick="selectTable('${table}')">${table}</button>`
            ).join('');

            modalContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800">${getText('select_table_title')}</h2>
                <div class="grid grid-cols-3 gap-4">${tableButtonsHtml}</div>
            `;
            
            // UIの表示/非表示制御
            overlay.style.display = 'flex';
            mainContent.classList.add('hidden');
            mainFooter.classList.add('hidden');
            header.classList.add('hidden');
        }

        /**
         * テーブルを選択し、メインメニューを表示する
         * @param {string} table - 選択されたテーブルID (例: 'T1')
         */
        function selectTable(table) {
            currentTable = table;
            const overlay = document.getElementById('table-modal-overlay');
            const mainContent = document.getElementById('main-content');
            const mainFooter = document.getElementById('main-footer');
            const header = document.getElementById('main-header');

            if (!overlay || !mainContent || !mainFooter || !header) return;

            // モーダルを非表示にし、メインコンテンツを表示
            overlay.style.display = 'none';
            mainContent.classList.remove('hidden');
            mainFooter.classList.remove('hidden');
            header.classList.remove('hidden');

            // UIを完全にレンダリング
            renderAllUI();
        }
        
        /**
         * チップ詳細ボックスのトグル
         */
        function toggleTipDetails() {
            const detailsBox = document.getElementById('tip-details-box');
            if (!detailsBox) return;

            detailsBox.classList.toggle('hidden');
            renderStaticElements(); // トグルボタンのテキストを更新
        }

        /**
         * チップ選択ボタンのレンダリング
         */
        function renderTipButtons() {
            const buttonContainer = document.getElementById('tip-buttons');
            if (!buttonContainer) return;

            let html = TIP_RATES.map(rate => {
                const isSelected = rate === currentTipRate;
                const buttonClass = isSelected ? 'tip-selected bg-primary-blue text-white' : 'tip-unselected';
                const rateText = formatTipRate(rate);

                return `
                    <div class="tip-label">
                        <button class="tip-button ${buttonClass}" 
                            onclick="selectTip(${rate})">
                            ${rateText}
                        </button>
                    </div>
                `;
            }).join('');
            
            buttonContainer.innerHTML = html;
        }

        /**
         * チップ率の選択
         */
        function selectTip(rate) {
            currentTipRate = rate;
            renderTipButtons(); // 選択状態を更新
            updateTotal(); // 合計金額を再計算
        }
        
        /**
         * 注文をFirebaseに送信
         */
        function sendOrder() {
            const totals = calculateTotal();
            
            if (totals.itemCount === 0) {
                showMessage(getText('message_error'), 'error');
                return;
            }

            const orderDetails = {
                table: currentTable,
                subtotal: totals.subtotal,
                tip_rate: currentTipRate,
                tip_amount: totals.tipAmount,
                total: totals.total,
                items: Object.values(cart).map(item => ({
                    code: item.product.code,
                    name: item.product[`name_${currentLang}`] || item.product.name_ja,
                    quantity: item.quantity,
                    price: item.price,
                    line_total: item.price * item.quantity
                })),
                timestamp: new Date().toISOString()
            };

            const db = firebase.database();
            db.ref(`orders/${currentTable}/${Date.now()}`).set(orderDetails)
                .then(() => {
                    // 成功時の処理
                    cart = {}; // カートをクリア
                    renderAllUI();
                    showMessage(getText('message_sent_success'), 'success');
                })
                .catch((error) => {
                    // 失敗時の処理
                    console.error("Firebase送信エラー:", error);
                    showMessage(getText('message_sent_failure') + '\n' + error.message, 'error');
                });
        }

        /**
         * 全てのUIコンポーネントをレンダリング/更新
         */
        function renderAllUI() {
            renderStaticElements(); 
            renderFilterControls();
            renderCategoryTabs();
            renderProductList();
            renderTipButtons();
            updateTotal(); 
        }

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {
            // Firebaseが初期化されていることを確認
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
                firebase.initializeApp(firebaseConfig);
            }
            
            currentCategory = getText('category_all');
            
            // 初回ロード時にテーブル選択モーダルを表示 (テーブル選択までメインコンテンツは隠れている)
            showTableModal(); 
        });


        // ------------------------------------------------------
        // III. 商品データ (const products) の定義
        // ------------------------------------------------------
        const products = [
            {
                code: 'P001', 
                name_ja: 'コーヒー', 
                name_en: 'Coffee', 
                price: 450, 
                isVegan: true, 
                isCooked: false, 
                hasAllergens: false, 
                notes_ja: 'ホット/アイス', 
                notes_en: 'Hot/Iced',
                category_ja: 'ドリンク',
                category_en: 'Drinks'
            },
            {
                code: 'P002', 
                name_ja: '自家製ハンバーガー', 
                name_en: 'Homemade Burger', 
                price: 1200, 
                isVegan: false, 
                isCooked: true, 
                hasAllergens: true, 
                notes_ja: 'フライドポテト付き', 
                notes_en: 'w/ Fries',
                category_ja: 'メイン',
                category_en: 'Main'
            },
            {
                code: 'P003', 
                name_ja: 'ヴィーガンサラダ', 
                name_en: 'Vegan Salad', 
                price: 850, 
                isVegan: true, 
                isCooked: false, 
                hasAllergens: false, 
                notes_ja: '自家製ドレッシング', 
                notes_en: 'Homemade Dressing',
                category_ja: 'サラダ',
                category_en: 'Salad'
            },
            {
                code: 'P004', 
                name_ja: 'ホットドッグ', 
                name_en: 'Hot Dog', 
                price: 700, 
                isVegan: false, 
                isCooked: true, 
                hasAllergens: true, 
                notes_ja: 'チーズトッピング(+100)', 
                notes_en: 'Cheese topping (+100)',
                category_ja: 'メイン',
                category_en: 'Main'
            },
            {
                code: 'P005', 
                name_ja: 'コーラ', 
                name_en: 'Coke', 
                price: 300, 
                isVegan: true, 
                isCooked: false, 
                hasAllergens: false, 
                notes_ja: 'S/M/Lサイズ', 
                notes_en: 'S/M/L size',
                category_ja: 'ドリンク',
                category_en: 'Drinks'
            }
        ];
    </script>
</body>
</html>
